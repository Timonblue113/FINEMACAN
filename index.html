<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tra c·ª©u H√†ng h√≥a ‚Äì SKU / UPC</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

<style>
  .suggestions { max-height: 260px; overflow-y: auto; position: absolute; z-index: 50; width: 100%; }
  .suggestion-item:hover { background: #eef2ff; cursor: pointer; }
  .table-scroll { max-height: 500px; overflow: auto; }
  table th, table td { text-align: left; vertical-align: middle; }
  tr:hover { background-color: #f0f9ff; }
  .wrap-text { white-space: normal; word-wrap: break-word; }
  .sticky-header th { position: sticky; top: 0; background: inherit; z-index: 10; }

  /* Dark mode */
  .dark body { background: #0f172a; color: #e2e8f0; }
  .dark .bg-white { background: #1e293b !important; color: #e2e8f0 !important; }
  .dark .border { border-color: #334155 !important; }
  .dark input, .dark select { background: #1e293b !important; color: #e2e8f0 !important; }
  .dark .suggestion-item:hover { background: #334155 !important; }
  .dark table th, .dark table td { color: #e2e8f0; }
</style>
</head>
<body class="bg-slate-50 text-slate-800">

<div class="max-w-6xl mx-auto p-6">

  <header class="flex justify-between items-start mb-4">
    <div>
      <h1 class="text-2xl font-semibold">Tra c·ª©u H√†ng h√≥a ‚Äî SKU / UPC</h1>
      <p class="text-sm text-slate-600 dark:text-slate-400">Fuzzy ‚Ä¢ Substring ‚Ä¢ G·ª£i √Ω nhanh</p>
    </div>
    <button id="toggleDark"
      class="px-3 py-2 rounded-md bg-slate-200 dark:bg-slate-700 dark:text-white text-sm">üåô Dark Mode</button>
  </header>

  <!-- Search -->
  <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm relative">
   <div class="flex flex-col sm:flex-row gap-2 items-stretch">
  <div class="relative flex-1">
    <input id="searchBox" placeholder="T√¨m t√™n / SKU / UPC..." 
           class="w-full p-3 border rounded-md dark:bg-slate-800 dark:border-slate-600" />
    <div id="suggestions" class="suggestions bg-white dark:bg-slate-800 border rounded-md hidden"></div>
  </div>
  <select id="mode" class="p-2 border rounded-md dark:bg-slate-800 dark:border-slate-600 text-sm w-full sm:w-auto">
    <option value="fuzzy">Fuzzy</option>
    <option value="substr">Substring</option>
  </select>
  <button id="clearBtn" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-md w-full sm:w-auto">X√≥a</button>
  <button id="searchBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md w-full sm:w-auto">T√¨m</button>
</div>
    <div class="flex items-center gap-3 mt-3 text-sm text-slate-600 dark:text-slate-400">
      <div id="stats">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div class="ml-auto">Hi·ªÉn th·ªã <span id="limitLabel">0</span> k·∫øt qu·∫£</div>
    </div>
    <div id="tableWrap" class="table-scroll border rounded-md mt-3"></div>
    <div class="mt-3 text-center">
      <button id="loadMore" class="px-4 py-2 bg-indigo-600 text-white rounded-md hidden">Xem th√™m</button>
    </div>
  </div>

  <!-- Export -->
  <div class="flex gap-2 mt-4">
    <button id="exportCsv" class="px-3 py-2 bg-green-600 text-white rounded-md text-sm">CSV</button>
    <button id="exportXlsx" class="px-3 py-2 bg-amber-600 text-white rounded-md text-sm">Excel</button>
  </div>

</div>

<script>
/* ---------------- Dark Mode ---------------- */
if(localStorage.getItem("dark")==="1") document.documentElement.classList.add("dark");
toggleDark.onclick = ()=> {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark", document.documentElement.classList.contains("dark")?"1":"0");
};

/* ---------------- Global ---------------- */
let DATA=[], results=[], ready=false, displayLimit=100;
const MAX_DISPLAY=2000;
const normalize = s=>(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");

/* ---------------- Worker ---------------- */
const workerCode = `
importScripts("https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js");
let DATA=[], fuse=null;
const normalize = s=>(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
onmessage = e=>{
  const {type,payload} = e.data;
  if(type==="load"){
    DATA = payload.data;
    fuse = new Fuse(DATA,{keys:["_search"], includeScore:true, threshold:0.35, ignoreLocation:true});
    postMessage({type:"loaded"});
  }
  if(type==="search"){
    const {query,mode,limit} = payload;
    let res=[];
    if(mode==="fuzzy" && fuse) res=fuse.search(query,{limit}).map(r=>r.item.index);
    else { 
      const nq=normalize(query); 
      res=DATA.filter(r=>r._search.includes(nq)).slice(0,limit).map(r=>r.index);
    }
    postMessage({type:"result", data:res});
  }
};
`;
const worker = new Worker(URL.createObjectURL(new Blob([workerCode],{type:"application/javascript"})));
worker.onmessage = e=>{
  const {type,data}=e.data;
  if(type==="loaded"){ ready=true; stats.textContent=`T·∫£i xong ${DATA.length} d√≤ng`; }
  if(type==="result"){
    results = data.map(i=>DATA[i]); // l·∫•y object g·ªëc
    displayLimit=100;
    stats.textContent=`T√¨m th·∫•y ${results.length}`;
    renderResults(results.slice(0,displayLimit));
  }
};

/* ---------------- Load Google Sheet ---------------- */
function findColIndex(keysLower, patterns){ for(let p of patterns){ const idx=keysLower.findIndex(x=>x.includes(p)); if(idx!==-1) return idx; } return -1; }

async function loadFromGoogleSheet(url){
  stats.textContent="ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...";
  try{
    const res = await fetch(url);
    let csvText = await res.text();
    csvText = csvText.replace(/^\uFEFF/, ""); // lo·∫°i b·ªè BOM n·∫øu c√≥
    const wb = XLSX.read(csvText, {type:"string"});
    const sheetName = wb.SheetNames[0];
    const sheet = wb.Sheets[sheetName];
    DATA = XLSX.utils.sheet_to_json(sheet, {defval:""}).map((r,i)=>{
      const keysOrig=Object.keys(r), keysLower=keysOrig.map(k=>String(k).toLowerCase());
      const idxName=findColIndex(keysLower, ["description","t√™n","name","product","item","hang","sp"]);
      const idxSku=findColIndex(keysLower, ["sku","m√£","ma","masp","code","itemcode","productcode"]);
      const idxUpc=findColIndex(keysLower, ["upc","ean","barcode","bar","mavach"]);
      const idxTon=findColIndex(keysLower, ["t·ªìn","ton","sl","s·ªë l∆∞·ª£ng","soluong","qty","quantity"]);
      const idxGia=findColIndex(keysLower, ["gi√°","gia","price"]);
      const name=idxName!==-1?String(r[keysOrig[idxName]]||"").normalize():"";
      const sku=idxSku!==-1?String(r[keysOrig[idxSku]]||"").normalize():"";
      const upc=idxUpc!==-1?String(r[keysOrig[idxUpc]]||"").normalize():"";
      const ton=idxTon!==-1?String(r[keysOrig[idxTon]]||"").normalize():"";
      const gia=idxGia!==-1?String(r[keysOrig[idxGia]]||"").normalize():"";
      return {name, sku, upc, ton, gia, _search:normalize(name+" "+sku+" "+upc), index:i};
    });
    worker.postMessage({type:"load", payload:{data:DATA.map(r=>({index:r.index,_search:r._search}))}});
    stats.textContent=`ƒê√£ n·∫°p ${DATA.length.toLocaleString()} d√≤ng t·ª´ Google Sheet`;
  }catch(e){
    console.error(e);
    stats.textContent="L·ªói t·∫£i d·ªØ li·ªáu";
  }
}

// Link Google Sheet CSV
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRz4AxA98HO_AjGHL2GaKW6Cgh4NcgZsnjLOIIHmArhmu_EzLsRjDasweJt9HvVH9RUsZ_E0jeF9-rf/pub?gid=0&single=true&output=csv";
loadFromGoogleSheet(sheetURL);

/* ---------------- Autocomplete ---------------- */
const debounce=(fn,time)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),time);};};
const doSuggest = debounce(()=>{
  const q=searchBox.value.trim(); if(!q||!DATA.length){ suggestions.classList.add("hidden"); return; }
  const nq=normalize(q);
  const sug=DATA.filter(x=>x._search.includes(nq)).slice(0,30);
  if(!sug.length){ suggestions.classList.add("hidden"); return; }
  suggestions.innerHTML = sug.map(x=>`<div class="p-2 suggestion-item cursor-pointer" data-name="${escapeHtml(x.name)}" data-sku="${escapeHtml(x.sku)}" data-upc="${escapeHtml(x.upc)}"><div class="font-medium truncate">${escapeHtml(x.name)}</div><div class="text-xs text-slate-500">SKU: ${escapeHtml(x.sku)} | UPC: ${escapeHtml(x.upc)}</div></div>`).join("");
  suggestions.classList.remove("hidden");
},120);

/* ---------------- Search ---------------- */
function executeSearch(){ 
  if(!ready) return alert("Ch∆∞a load danh m·ª•c!"); 
  const q=searchBox.value.trim(); 
  if(!q) return; 
  worker.postMessage({type:"search", payload:{query:q, mode:mode.value, limit:MAX_DISPLAY}}); 
}

/* ---------------- Render ---------------- */
function escapeHtml(s){return String(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));}
function renderResults(rows){
  limitLabel.textContent=rows.length;
  if(!rows.length){ tableWrap.innerHTML=`<div class="p-4 text-sm">Kh√¥ng c√≥ k·∫øt qu·∫£</div>`; loadMore.classList.add("hidden"); return; }
  let html=`<table class="min-w-full text-sm table-auto"><thead class="sticky-header"><tr class="bg-white dark:bg-slate-800"><th class="p-2 w-10">#</th><th class="p-2 w-32">SKU</th><th class="p-2 w-32">UPC</th><th class="p-2 w-64">T√™n h√†ng</th><th class="p-2 w-20">T·ªìn</th><th class="p-2 w-24">Gi√°</th></tr></thead><tbody>`;
  rows.forEach((r,i)=>{ html+=`<tr class="border-t dark:border-slate-700"><td class="p-2">${i+1}</td><td class="p-2">${escapeHtml(r.sku)}</td><td class="p-2">${escapeHtml(r.upc)}</td><td class="p-2 wrap-text">${escapeHtml(r.name)}</td><td class="p-2">${escapeHtml(r.ton)}</td><td class="p-2">${escapeHtml(r.gia)}</td></tr>`; });
  html+="</tbody></table>";
  tableWrap.innerHTML=html;
  if(results.length>rows.length) loadMore.classList.remove("hidden"); else loadMore.classList.add("hidden");
}

/* ---------------- Export ---------------- */
function exportCSV(items){
  if(!items.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export");
  const header="SKU,UPC,Description,T·ªìn,Gi√°\n";
  const body=items.map(r=>`"${r.sku.replace(/"/g,'""')}","${r.upc.replace(/"/g,'""')}","${r.name.replace(/"/g,'""')}","${r.ton.replace(/"/g,'""')}","${r.gia.replace(/"/g,'""')}"`).join("\n");
  const blob=new Blob([header+body],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="results.csv"; a.click(); URL.revokeObjectURL(url);
}
function exportXLSX(items){
  if(!items.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export");
  const ws=XLSX.utils.json_to_sheet(items.map(r=>({SKU:r.sku, UPC:r.upc, Description:r.name, Ton:r.ton, Gia:r.gia})));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"KQ"); XLSX.writeFile(wb,"results.xlsx");
}

/* ---------------- Events ---------------- */
searchBtn.onclick=executeSearch;
searchBox.onkeydown=e=>{if(e.key==="Enter") executeSearch();};
searchBox.oninput=doSuggest;
clearBtn.onclick=()=>{searchBox.value=""; results=[]; renderResults([]);};
suggestions.onclick=e=>{
  const row=e.target.closest(".suggestion-item"); 
  if(!row) return; 
  searchBox.value=row.dataset.name||row.dataset.sku||row.dataset.upc||""; 
  suggestions.classList.add("hidden"); 
  executeSearch();
};
document.body.onclick=e=>{if(!e.target.closest("#suggestions")&&!e.target.closest("#searchBox")) suggestions.classList.add("hidden");};
loadMore.onclick=()=>{displayLimit=Math.min(displayLimit+200,results.length); renderResults(results.slice(0,displayLimit));};
exportCsv.onclick=()=>exportCSV(results.slice(0,displayLimit));
exportXlsx.onclick=()=>exportXLSX(results.slice(0,displayLimit));
</script>
</body>
</html>
